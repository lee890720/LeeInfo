@model Tuple<FrxAccount, List<FrxAccount>, AccountInfo>
@{
    var actionName = ViewContext.RouteData.Values["action"].ToString();
    var controllerName = ViewContext.RouteData.Values["controller"].ToString();
    var areaName = ViewContext.RouteData.Values["area"].ToString();
    ViewData["action"] = actionName;
    ViewData["controller"] = controllerName;
    ViewData["area"] = areaName;
    ViewData["Title"] = controllerName;
    string path = "/" + areaName + "/" + controllerName;
}
<section class="content-header">
    <h1>
        @ViewData["action"]
        <small>@ViewData["controller"]</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> @ViewData["area"]</a></li>
        <li class="active"> @ViewData["controller"]</li>
    </ol>
</section>
<section class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">月度分析报告</h3>
                    <div class="box-tools pull-right">
                        <button id="MonthProfitBtn" type="button" class="btn btn-box-tool">NET</button>
                        <button id="MonthHandBtn" type="button" class="btn btn-box-tool">LOT</button>
                        <button id="MonthPointBtn" type="button" class="btn btn-box-tool">PIP</button>
                        <button id="MonthProfitRateBtn" type="button" class="btn btn-box-tool">ROI</button>
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-wrench"></i>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                @foreach (var f in Model.Item2)
                                {
                                    <li><a href="@Url.Action("Index","FrxHistory",new {  acId=f.AccountId })"><i class="fa fa-circle-o" style="color:skyblue"></i>@f.AccountNumber</a></li>
                                }
                            </ul>
                        </div>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="col-md-12">
                        <div id="MonthBaseChart" style="height: 300px;">
                            <!--月分析图表位置-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">多空比</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-wrench"></i>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                @foreach (var f in Model.Item2)
                                {
                                    <li><a href="@Url.Action("Index","FrxHistory",new {  acId=f.AccountId })"><i class="fa fa-circle-o" style="color:skyblue"></i>@f.AccountNumber</a></li>
                                }
                            </ul>
                        </div>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body no-margin">
                    <div class="col-md-8">
                        <div id="BuySellRateChart" class="clearfix" style="height: 300px; ">
                            <!--月Pie图表位置-->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="MonthPieChart" class="clearfix" style="height: 300px;">
                            <!--月Pie图表位置-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">摘要</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-wrench"></i>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                @foreach (var f in Model.Item2)
                                {
                                    <li><a href="@Url.Action("Index","FrxPosition",new { acId=f.AccountId })"><i class="fa fa-circle-o" style="color:skyblue"></i>@f.AccountNumber</a></li>
                                }
                            </ul>
                        </div>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body table-responsive" style="height:560px">
                    <table id="example_pos" class="table  table-bordered table-striped table-hover" width="100%">
                        <thead>
                            <tr>
                                <th></th>
                                <th colspan="4">多头</th>
                                <th colspan="4">空头</th>
                                <th colspan="6">总计</th>
                            </tr>
                            <tr>
                                <th>
                                    货币
                                </th>
                                <th>
                                    交易
                                </th>
                                <th>
                                    手
                                </th>
                                <th>
                                    点
                                </th>
                                <th>
                                    利润
                                </th>
                                <th>
                                    交易
                                </th>
                                <th>
                                    手
                                </th>
                                <th>
                                    点
                                </th>
                                <th>
                                    利润
                                </th>
                                <th>
                                    交易
                                </th>
                                <th>
                                    手
                                </th>
                                <th>
                                    点
                                </th>
                                <th>
                                    利润
                                </th>
                                <th>
                                    赢利
                                </th>
                                <th>
                                    亏损
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
@section Scripts{
    <script>
        $(document).ready(function () {
            //初始化数据
            var MonthBaseData = [];
            var MonthBaseChart = echarts.init(document.getElementById('MonthBaseChart'));
            var MonthPieChart = echarts.init(document.getElementById("MonthPieChart"));
            var BuySellRateChart = echarts.init(document.getElementById("BuySellRateChart"));

            if (MonthBaseData.length == 0) {
                $.ajax({
                    url: '@Url.Action("GetAnalyzeData", "FrxAnalyze", new { acId = Model.Item1.AccountId })',
                    async: true,
                    type: "post",
                    dataType: "json",
                    success: function (result) {
                        MonthBaseData = result.monthBaseData;
                        Render_MonthBaseChart(MonthBaseData, 1);
                        Render_MonthPieChart(11);
                        Render_BuySellRateChart(11);
                        table_pos.api().rows.add(result.monthBaseData[11].buySellData).draw();
                    }
                });

            }
            //月度分析报告
            MonthBaseChart.on('click', function (params) {
                Render_MonthPieChart(params.dataIndex);
                Render_BuySellRateChart(params.dataIndex);
                table_pos.api().clear();
                table_pos.api().rows.add(MonthBaseData[params.dataIndex].buySellData).draw();
            });

            var optionMonthBase = {
                color: ['#3398DB'],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    top: '10%',
                    bottom: '5%',
                    containLabel: true
                },
                xAxis:
                    {
                        type: 'category',
                        data: []
                    },
                yAxis: [
                    {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value}'
                        },
                    }

                ],
                series:
                    {
                        name: '',
                        type: 'bar',
                        barWidth: '60%',
                        data: [],
                        label: {
                            normal: {
                                show: true,
                                formatter: '{c}',
                                position: 'top',
                                textStyle: {
                                    color: '#000'
                                }
                            }
                        }
                    }
            };

            function Render_MonthBaseChart(data, type) {

                optionMonthBase.xAxis.data = [];
                optionMonthBase.series.data = [];

                var seriesName = "";

                if (type == 1) {
                    seriesName = "收益率";
                }
                else if (type == 2) {
                    seriesName = "利润";
                }
                else if (type == 3) {
                    seriesName = "手数";
                }
                else if (type == 4) {
                    seriesName = "点数";
                }

                optionMonthBase.series.name = seriesName;
                if (data != null) {
                    $.each(data, function () {
                        optionMonthBase.xAxis.data.push(this.xData.xName);
                        //收益率
                        if (type == 1) {
                            optionMonthBase.series.data.push((this.gain * 100).toFixed(2));
                            optionMonthBase.series.label.normal.formatter = function (p) {
                                return (p.value > 0 || p.value < 0) ? (p.value + '%') : '';
                            };
                        }
                        //收益
                        else if (type == 2) {
                            optionMonthBase.series.data.push(this.net.toFixed(2));
                            optionMonthBase.series.label.normal.formatter = function (p) {
                                return (p.value > 0 || p.value < 0) ? ('$' + p.value) : '';
                            };
                        }
                        //手数
                        else if (type == 3) {
                            optionMonthBase.series.data.push(this.lots.toFixed(2));
                            optionMonthBase.series.label.normal.formatter = function (p) {
                                return (p.value > 0 || p.value < 0) ? ('l.' + p.value) : '';
                            };
                        }
                        //点数
                        else if (type == 4) {
                            optionMonthBase.series.data.push(this.pips.toFixed(2));
                            optionMonthBase.series.label.normal.formatter = function (p) {
                                return (p.value > 0 || p.value < 0) ? ('p.' + p.value) : '';
                            };
                        }
                    })

                    if (type == 1) {
                        optionMonthBase.yAxis[0].axisLabel.formatter = '{value} %';
                        optionMonthBase.tooltip.formatter = "{a} <br/>{b} : {c} %";
                    } else {
                        optionMonthBase.yAxis[0].axisLabel.formatter = '{value} ';
                        optionMonthBase.tooltip.formatter = "{a} <br/>{b} : {c}";
                    }
                    MonthBaseChart.setOption(optionMonthBase);
                }
            }

            //月Pie图表
            var optionMonthPie = {
                title: {
                    text: 'MonthPie',
                    show: false
                },
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                },
                legend: {
                    show: false,
                    type: 'plain',
                    tooltip: {
                        show: true
                    },
                    orient: 'vertical',
                    right: 10,
                    top: 20,
                    bottom: 20,
                    data: []
                },
                series: [
                    {
                        name: 'SymbolCode',
                        type: 'pie',
                        radius: [0,'55%'],
                        center: ['50%', '50%'],
                        label: {
                            normal: {
                                formatter: '{b} {d}%',
                            }
                        },
                        data: [],
                        itemStyle: {
                            emphasis: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };

            function Render_MonthPieChart(index) {
                var seriesData = [];
                var data= MonthBaseData;
                var idx = parseInt(index);
                for (var i = 0; i < data[idx].buySellData.length; i++) {
                    var _name = data[idx].buySellData[i].symbolCode;
                    var _value = parseFloat(data[idx].buySellData[i].lots).toFixed(2);;
                    seriesData.push({ name: _name, value: _value });
                }
                optionMonthPie.series[0].data = seriesData;
                MonthPieChart.setOption(optionMonthPie);
            };

            //月多空比
            var optionBuySellRate={
                tooltip: {
                    trigger: 'axis',
                        axisPointer: {
                        type: 'shadow'
                    }
                },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                axisLabel: {
                    show: true,
                    interval: 0,
                    rotate: 90,
                }
            },
            yAxis: {
                type: 'value',
            },
            series: [
                {
                    name: '多头',
                    type: 'bar',
                    stack: '总量',
                    label: {
                        normal: {
                            show: true,
                            rotate: 90,
                            align: 'left',
                            verticalAlign: 'middle',
                            position: 'insideBottom',
                            distance: 3,
                        }
                    },
                    data:[],
                    itemStyle: {
                        normal: { color: '#eecb71' }
                    }
                },
                {
                    name: '空头',
                    type: 'bar',
                    stack: '总量',
                    label: {
                        normal: {
                            show: true,
                            rotate: 90,
                            align: 'left',
                            verticalAlign: 'middle',
                            position: 'insideBottom',
                            distance:3,
                        }
                    },
                    data: [],
                    itemStyle: {
                        normal: { color: '#cbe2f3' }
                    }
                }
            ]
        };

            function Render_BuySellRateChart(index) {
                var buydata = [];
                var selldata=[];
                var xnamedata=[];
                var data=MonthBaseData;
                var idx = parseInt(index);
                for (var i = 0; i < data[idx].buySellData.length; i++) {
                    var _name = data[idx].buySellData[i].symbolCode;
                    var _buy = parseFloat(data[idx].buySellData[i].buyRate).toFixed(2);
                    var _sell = parseFloat(data[idx].buySellData[i].sellRate).toFixed(2);
                    xnamedata.push(_name);
                    buydata.push(_buy);
                    selldata.push(_sell);
                }
                optionBuySellRate.xAxis.data = xnamedata;
                optionBuySellRate.series[0].data = buydata;
                optionBuySellRate.series[1].data = selldata;
                optionBuySellRate.series[0].label.normal.formatter = function (p) {
                    return (p.value > 0 || p.value < 0) ? (p.value) : '';
                };
                optionBuySellRate.series[1].label.normal.formatter = function (p) {
                    return (p.value > 0 || p.value < 0) ? (p.value) : '';
                };
                BuySellRateChart.setOption(optionBuySellRate);
             };

            //月份收益率
            $("#MonthProfitRateBtn").click(function () {
                Render_MonthBaseChart(MonthBaseData, 1);
            });

            //月份收益
            $("#MonthProfitBtn").click(function () {
                Render_MonthBaseChart(MonthBaseData, 2);
            });

            //月份手数
            $("#MonthHandBtn").click(function () {
                Render_MonthBaseChart(MonthBaseData, 3);
            });

            //月份点数
            $("#MonthPointBtn").click(function () {
                Render_MonthBaseChart(MonthBaseData, 4);
            });

            //For DataTables
            var table_pos = $('#example_pos').dataTable(
                {
                    'dom':
                        "<'row'<'col-sm-6'><'col-sm-6'f>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                    'processing': true,
                    'data':[],
                    'columns': [
                        { "data": "symbolCode" },
                        { "data": "buyCount" },
                        { "data": "buyLots" },
                        { "data": "buyPips" },
                        { "data": "buyProfit" },
                        { "data": "sellCount" },
                        { "data": "sellLots" },
                        { "data": "sellPips" },
                        { "data": "sellProfit" },
                        { "data": "count" },
                        { "data": "lots" },
                        { "data": "pips" },
                        { "data": "profit" },
                        { "data": "winRate" },
                        { "data": "lossRate" },
                    ],
                    "columnDefs": [
                        {
                            "targets": [2, 3, 4, 6, 7, 8, 10, 11, 12],
                            render: function (data, type, row, meta) {
                                return data.toString() == "NaN" ? parseFloat(0).toFixed(2):parseFloat(data).toFixed(2);
                            }
                        },
                        {
                            "targets": [ 3, 4,  7, 8,  11, 12],
                            "createdCell": function (td, cellData, rowData, row, col) {
                                if (cellData > 0)
                                    $(td).css('color', '#4cae05');
                                else
                                    $(td).css('color', '#ff5256');
                            },
                        },
                        {
                            "targets": 13,
                            "orderable":false,
                            "createdCell": function (td, cellData, rowData, row, col) {
                                $(td).css('color', '#4cae05');
                            },
                            render: function (data, type, row, meta) {
                                return row.winCount + "(" + (row.winRate*100).toFixed(2)+"%)";
                            }
                        },
                        {
                            "targets": 14,
                            "orderable":false,
                            "createdCell": function (td, cellData, rowData, row, col) {
                                $(td).css('color', '#ff5256');
                            },
                            render: function (data, type, row, meta) {
                                return row.lossCount + "(" + (row.lossRate * 100).toFixed(2) + "%)";
                            }
                        },
                        ],
                });
        });
    </script>
}
