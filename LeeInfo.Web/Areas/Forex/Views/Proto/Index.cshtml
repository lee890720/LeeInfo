@model Tuple<FrxAccount, List<FrxAccount>, List<PosGroup>>
@{
    var actionName = ViewContext.RouteData.Values["action"].ToString();
    var controllerName = ViewContext.RouteData.Values["controller"].ToString();
    var areaName = ViewContext.RouteData.Values["area"].ToString();
    ViewData["action"] = actionName;
    ViewData["controller"] = controllerName;
    ViewData["area"] = areaName;
    ViewData["Title"] = controllerName;
    string path = "/" + areaName + "/" + controllerName;
}
<style>
    .table th {
        text-align: center !important;
    }

    .table td {
        text-align: center !important;
        vertical-align: middle !important;
    }

    .description-text {
        color: darkgray !important;
    }
</style>
<section class="content-header">
    <h1>
        @ViewData["action"]
        <small>@ViewData["controller"]</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> @ViewData["area"]</a></li>
        <li class="active"> @ViewData["controller"]</li>
    </ol>
</section>
<section class="content">
    <div class="row">
        <div class="col-md-3">
            <!--新建订单-->
            <div id="new-box" class="box box-solid collapsed-box">
                <div class="box-header with-border">
                    <h3 class="box-title">新建订单</h3>
                    <div class="box-tools">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">买多价</span>
                            <input type="text" class="form-control" placeholder="1.02451" disabled="disabled">
                            <span class="input-group-addon">卖空价</span>
                            <input type="text" class="form-control" placeholder="1.04578" disabled="disabled">
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">品种</span>
                            <select id="new-symbol" class="form-control select2" style="width: 100%;">
                            </select>
                            <span title="是否可以从持仓明细中选择，默认为不可以" class="input-group-addon"><input type="checkbox" id="symbolcheck" class="flat-blue" /></span>
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">数量</span>
                            <div class="row">
                                <div class="col-xs-6" style="padding-right:0px;">
                                    <input id="new-volume" type="text" class="form-control" placeholder="数量 二选一">
                                </div>
                                <div class="col-xs-6" style="padding-left:0px;">
                                    <input id="new-lot" type="text" class="form-control" placeholder="手数 二选一">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">多空</span>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="买（多）" disabled="disabled">
                                <span class="input-group-addon"><input type="radio" id="tradetypebuy" name="tradetype" value="buy" class="flat-blue" checked /></span>
                                <input type="text" class="form-control" placeholder="卖（空）" disabled="disabled">
                                <span class="input-group-addon"><input type="radio" id="tradetypesell" name="tradetype" value="sell" class="flat-blue" /></span>
                            </div>

                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">止赢</span>
                            <div class="row">
                                <div class="col-xs-6" style="padding-right:0px;">
                                    <input id="new-takeprofitprice" type="text" class="form-control" placeholder="止赢价 可选">
                                </div>
                                <div class="col-xs-6" style="padding-left:0px;">
                                    <input id="new-takeprofitpips" type="text" class="form-control" placeholder="止赢点数 可选">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">止损</span>
                            <div class="row">
                                <div class="col-xs-6" style="padding-right:0px;">
                                    <input id="new-stoplossprice" type="text" class="form-control" placeholder="止损价 可选">
                                </div>
                                <div class="col-xs-6" style="padding-left:0px;">
                                    <input id="new-stoplosspips" type="text" class="form-control" placeholder="止损点数 可选">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">标签</span>
                            <input id="new-label" type="text" class="form-control" placeholder="可选">
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">注释</span>
                            <input id="new-comment" type="text" class="form-control" placeholder="可选">
                        </div>
                        <br>
                        <button class="btn btn-primary btn-block margin-bottom">提交</button>
                    </div>
                </div>
            </div>
            <!--修改订单-->
            <div id="amend-box" class="box box-solid collapsed-box">
                <div class="box-header with-border">
                    <h3 class="box-title">修改订单</h3>
                    <div class="box-tools">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-addon">单号</span>
                            <input id="amend-id" type="text" class="form-control" placeholder="请从持仓明细中选择">
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">品种</span>
                            <input id="amend-symbol" type="text" class="form-control" placeholder="必填">
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">止赢</span>
                            <div class="row">
                                <div class="col-xs-6" style="padding-right:0px;">
                                    <input id="amend-takeprofitprice" type="text" class="form-control" placeholder="止赢价 可选">
                                </div>
                                <div class="col-xs-6" style="padding-left:0px;">
                                    <input id="amend-takeprofitpips" type="text" class="form-control" placeholder="止赢点数 可选">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="input-group">
                            <span class="input-group-addon">止损</span>
                            <div class="row">
                                <div class="col-xs-6" style="padding-right:0px;">
                                    <input id="amend-stoplossprice" type="text" class="form-control" placeholder="止损价 可选">
                                </div>
                                <div class="col-xs-6" style="padding-left:0px;">
                                    <input id="amend-stoplosspips" type="text" class="form-control" placeholder="止损点数 可选">
                                </div>
                            </div>
                        </div>
                        <br>
                        <button class="btn btn-primary btn-block margin-bottom">提交</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <!--持仓明细-->
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">持仓明细</h3>

                    <div class="box-tools pull-right">
                        <div class="has-feedback">
                            <input id="search" type="text" class="form-control input-sm" placeholder="搜索">
                            <span class="glyphicon glyphicon-search form-control-feedback"></span>
                        </div>
                    </div>
                </div>
                <div class="box-body" style="padding:0px 5px;">
                    <div class="mailbox-controls">
                        <button title="全选" type="button" class="btn btn-default btn-sm checkbox-toggle">
                            <i class="fa fa-square-o"></i>
                        </button>
                        <button title="关闭选中的订单" type="button" class="btn btn-default btn-sm"><i class="fa fa-trash-o"></i></button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" title="切换账号">
                                <i class="fa fa-wrench"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-left" role="menu">
                                @foreach (var f in Model.Item2)
                                {
                                    <li><a href="@Url.Action("Index","Proto",new { acId=f.AccountId })"><i class="fa fa-circle-o text-light-blue"></i>@f.AccountNumber</a></li>
                                }
                            </ul>
                        </div>
                        <div class="pull-right">
                            <button id="refrash" title="刷新持仓明细" type="button" class="btn btn-default btn-sm"><i class="fa fa-refresh"></i></button>
                        </div>
                    </div>
                    <div class="table-responsive  mailbox-messages">
                        <table id="example_pos" class="table table-hover" width="100%">
                            <thead>
                                <tr>
                                    <th>
                                        ID(标签/注释)
                                    </th>
                                    <th>
                                        品种
                                    </th>
                                    <th>
                                        手数
                                    </th>
                                    <th>
                                        多空
                                    </th>
                                    <th>
                                        开仓时间
                                    </th>
                                    <th>
                                        开仓价
                                    </th>
                                    <th>
                                        当前价
                                    </th>
                                    <th>
                                        利息
                                    </th>
                                    <th>
                                        止赢
                                    </th>
                                    <th>
                                        止损
                                    </th>
                                    <th>
                                        点数
                                    </th>
                                    <th>
                                        利润
                                    </th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="box-footer no-padding">
                    <div class="mailbox-controls">
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block border-right">
                                <h5 class="description-header">$@Model.Item1.Balance</h5>
                                <span class="description-text">账户余额</span>
                            </div>
                        </div>
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block border-right">
                                <h5 class="description-header">$@Model.Item1.Equity</h5>
                                <span class="description-text">账户净值</span>
                            </div>
                        </div>
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block border-right">
                                <h5 id="unrnet" class="description-header" style="color:#4cae05">$@Model.Item1.UnrealizedNetProfit</h5>
                                <span class="description-text">账户净浮动</span>
                            </div>
                        </div>
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block border-right">
                                <h5 class="description-header">$@Model.Item1.MarginUsed</h5>
                                <span class="description-text">已用保证金</span>
                            </div>
                        </div>
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block border-right">
                                <h5 class="description-header">$@Model.Item1.FreeMargin</h5>
                                <span class="description-text">可用保证金</span>
                            </div>
                        </div>
                        <div class="col-sm-2 col-xs-4">
                            <div class="description-block">
                                <h5 class="description-header">@Model.Item1.MarginLevel %</h5>
                                <span class="description-text">保证金水平</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
@section Scripts{
    <script>
        $(function () {
            //初始化参数
            var _accountId =@Model.Item1.AccountId;
            var _getPositionUrl = "/Forex/Proto/GetPosition";
            var _getSymbolUrl = "/Forex/Proto/GetSymbol";
            var _positions = [];
            var _symbols = [];
            GetPosition();
            GetSymbol();

            //#region GetPosition
            function GetPosition() {
                var tempdata = {acId:_accountId};
                $.ajax({
                    type: "post",
                    async: true,
                    url: _getPositionUrl,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify(tempdata),
                    success: function (result) {
                        _positions = result.data;
                        table_pos.api().clear();
                        table_pos.api().rows.add(result.data).draw();
                    },
                    error: function (errorMsg) {
                        alert("Position请求数据失败!");
                    }
                })
            };
            //#endregion

            //#region GetSymbol
            function GetSymbol() {
                var tempdata = {};
                $.ajax({
                    type: "post",
                    async: true,
                    url: _getSymbolUrl,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify(tempdata),
                    success: function (result) {
                        _symbols = result.data;
                        GetSymbolList();
                    },
                    error: function (errorMsg) {
                        alert("Symbol请求数据失败!");
                    }
                })
            };
            //#endregion

            //#region 初始化table_pos
            var table_pos = $('#example_pos').dataTable(
                {
                    'order': [[5, "desc"]],
                    'info': false,
                    'paging': false,
                    'dom':
                        "<'row'<'col-sm-6'><'col-sm-6'>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                    'processing': true,
                    'data':[],
                    "language": {
                        "processing": "加载中...",
                        "lengthMenu": "每页显示 _MENU_ 条数据",
                        "zeroRecords": "没有匹配结果",
                        "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                        "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
                        "infoFiltered": "(由 _MAX_ 项结果过滤)",
                        "infoPostFix": "",
                        "search": "搜索:",
                        "url": "",
                        "emptyTable": "没有匹配结果",
                        "loadingRecords": "载入中...",
                        "thousands": ",",
                        "paginate": {
                            "first": "首页",
                            "previous": "上一页",
                            "next": "下一页",
                            "last": "末页"
                        },
                        "aria": {
                            "sortAscending": ": 以升序排列此列",
                            "sortDescending": ": 以降序排列此列"
                        }
                    },
                    'columns': [
                        { "data": "id" },
                        { "data": "symbolCode" },
                        { "data": "quantity" },
                        { "data": "tradeType" },
                        { "data": "entryTime" },
                        { "data": "entryPrice" },
                        { "data": "currentPrice" },
                        { "data": "swap" },
                        { "data": "takeProfit" },
                        { "data": "stopLoss" },
                        { "data": "pips" },
                        { "data": "netProfit" },
                    ],
                    "columnDefs": [
                        {
                            "targets": 0,
                            "orderable": false,
                            render: function (data, type, row, meta) {
                                return '<span title="' + row.label + '/' + row.comment + '">' + '<input type="checkbox" class="icheckbox_flat-blue" name="ids" value="' + row.id + '">'+ data + '</span>';
                            }
                        },
                        {
                            "targets": 3,
                            render: function (data, type, row, meta) {
                                var tradetype = data;
                                if (tradetype == 0)
                                    return "BUY";
                                if (tradetype == 1)
                                    return "SELL";
                            }
                        },
                        {
                            "targets": 4,
                            render: function (data, type, row, meta) {
                                result = moment(data).format('YYYY-MM-DD hh:mm:ss');
                                return result;
                            }
                        },
                        {
                            "targets": [5, 6, 8, 9],
                            "orderable": false,
                            render: function (data, type, row, meta) {
                                var result = parseFloat(data);
                                return result.toFixed(parseInt(row.digits));
                            }
                        },
                        {
                            "targets": -2,
                            render: function (data, type, row, meta) {
                                var result = parseFloat(data);
                                return Math.round(result);
                            }
                        },
                        {
                            "targets": -1,
                            render: function (data, type, row, meta) {
                                var result = parseFloat(data);
                                return result.toFixed(2);
                            }
                        },
                        {
                            "targets": [7, 10,11],
                            "createdCell": function (td, cellData, rowData, row, col) {
                                if (cellData > 0)
                                    $(td).css('color', '#4cae05');
                                else
                                    $(td).css('color', '#ff5256');
                            },
                        },
                    ],
                    "footerCallback": function (tfoot, data, start, end, display) {
                        var api = this.api(), data;

                        // Remove the formatting to get integer data for summation
                        var intVal = function (i) { return typeof i === 'string' ? i.replace(/[\$,]/g, '') * 1 : typeof i === 'number' ? i : 0; };

                        // Total over all pages
                        total = api.column(11).data().reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                        // Total over this page
                        pageTotal = api.column(11, { page: 'current' }).data().reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                        // Update footer
                        $(api.column(11).footer()).html('$' + pageTotal.toFixed(2) + "/" + '$' + total.toFixed(2));
                    }
                });
            $("#search").keyup(function () { table_pos.api().search($("#search").val()).draw(); });
            $("#refrash").click(function () { GetPosition(); alert("Refrashed");});
            //#endregion

            //#region 设置新建订单和修改订单的值
            $("#symbolcheck").on("ifUnchecked", function () {
                $("#new-box .form-control").val("");
                $("#new-symbol").val(1);
                $("#new-symbol").select2().val(1).trigger("change");
            });
            $("#example_pos tbody").on("click", 'tr', function () {
                //var $tr = $(this).parents('tr');
                var row = table_pos.api().row($(this));
                var data = row.data();
                $(".col-md-3 .form-control").val("");
                $("#amend-id").val(data.id);
                $("#amend-symbol").val(data.symbolCode);
                if (data.takeProfit != null) {
                    $("#amend-takeprofitprice").val(data.takeProfit);
                }
                if (data.stopLoss != null) {
                    $("#amend-stoplossprice").val(data.stopLoss);
                }

                if ($("#symbolcheck").is(':checked')) {
                    var radio = GetRadioValue("tradetype");
                    var selectvalue = 1;
                    $.each(_symbols, function () {
                        if (this.symbolName == data.symbolCode) {
                            selectvalue = this.symbolId;
                            return false;
                        }
                    });
                    $("#new-symbol").val(selectvalue);
                    var showsymbol = $("#new-symbol").find("option:selected").text();
                    $("#new-symbol").select2().val(selectvalue).trigger("change");
                    $("#new-volume").val(data.volume);
                    if (data.tradeType == 0 && radio == "sell") {
                        $("#tradetypesell").iCheck("uncheck");
                        $("#tradetypebuy").iCheck("check");
                    }
                    if (data.tradeType == 1 && radio == "buy") {
                        $("#tradetypebuy").iCheck("uncheck");
                        $("#tradetypesell").iCheck("check");
                    }
                    if (data.takeProfit != null) {
                        $("#new-takeprofitprice").val(data.takeProfit);
                    }
                    if (data.stopLoss != null) {
                        $("#new-stoplossprice").val(data.stopLoss);
                    }
                    if (data.label != null) {
                        $("#new-label").val(data.label);
                    }
                    if (data.comment != null) {
                        $("#new-comment").val(data.comment);
                    }
                }
        });

            function GetRadioValue(RadioName) {
            var obj;
            obj = document.getElementsByName(RadioName);
            if (obj != null) {
                var i;
                for (i = 0; i < obj.length; i++) {
                    if (obj[i].checked) {
                        return obj[i].value;
                    }
                }
            }
            return null;
        };
            //#endregion

            //#region 设置一些细节
            //初始化Select2
            $('.select2').select2();

            //Enable check and uncheck all functionality
            $(".checkbox-toggle").click(function () {
                var clicks = $(this).data('clicks');
                if (clicks) {
                    //Uncheck all checkboxes
                    $(".mailbox-messages input[type='checkbox']").iCheck("uncheck");
                    $(".fa", this).removeClass("fa-check-square-o").addClass('fa-square-o');
                } else {
                    //Check all checkboxes
                    $(".mailbox-messages input[type='checkbox']").iCheck("check");
                    $(".fa", this).removeClass("fa-square-o").addClass('fa-check-square-o');
                }
                $(this).data("clicks", !clicks);
            });

            //设置unrnet的颜色
            if ($("#unrnet").innerHTML > 0) {
                $("#unrnet").css('color', '#4cae05');
            }
            else {
                $("#unrnet").css('color', '#ff5256');
            }
            //#endregion

            //#region 设置select(new-symbol)
            function GetSymbolList(){
                $.each(_symbols, function () {
                    $("#new-symbol").append("<option value='" + this.symbolId + "'>" + this.symbolName + "</option>");
                });
            }
            //#endregion
        });
    </script>
}
